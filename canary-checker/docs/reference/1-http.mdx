---
title: HTTP
sidebar_class_name: popular
---

# <Icon name="http"/> HTTP

This check performs queries on HTTP endpoints, and HTTP namespaces to monitor their activity.

```yaml title=http-check.yaml
apiVersion: canaries.flanksource.com/v1
kind: Canary
metadata:
  name: http-check
spec:
  interval: 30
  http:
    - name: http pass response 200 status code
      endpoint: https://httpbin.demo.aws.flanksource.com/status/200
      thresholdMillis: 3000
      responseCodes: [201, 200, 301]
      maxSSLExpiry: 7
```

<HealthCheck name="http" connection="url"  rows={[
  {field: "endpoint", description: "HTTP URL", scheme: "string", required: true},
  {field: "method", description: "HTTP Request method", default: "GET", scheme: "string"},
  {field: "headers", description: "Header fields", scheme: "map[string]string"},
  {field: "body", description: "Request Body Contents", scheme: "string"},
  {field: "tlsConfig", description: "TLS config", scheme: "[TLSConfig](#tls-config)"},
  {field: "templateBody", description: "If true body is templated", default: false, scheme: "bool"},
  {field: "responseCodes", description: "Expected response codes", scheme: "[]int"},
  {field: "responseContent", description: "Expected response content", scheme: "string"},
  {field: "thresholdMillis", description: "Request timeout", default: 5000, scheme: "int"},
  {field: "maxSSLExpiry", description: "Max SSL expiry days", scheme: "int"},
  {field: "insecureSkipVerify", description: "Skip TLS verification", scheme: "bool"},
  {field: "env", description: "Setup environment variables that are accessible while templating", scheme: "[]EnvVar"},
]}/>

### TLS Config

<Fields rows={[
  {field: "ca", description: "PEM encoded certificate of the CA to verify the server certificate", scheme: "EnvVar"},
  {field: "cert", description: "PEM encoded client certificate", scheme: "EnvVar"},
  {field: "key", description: "PEM encoded client private key", scheme: "EnvVar"},
  {field: "handshakeTimeout", description: "Timeout for SSL handshake (defaults to 10 seconds)", scheme: "int"},
  {field: "insecureSkipVerify", description: "Controls whether a client verifies the server's certificate chain and host name", scheme: "bool"}
]}/>

<details summary="Example">

```yaml title=http-check.yaml
apiVersion: canaries.flanksource.com/v1
kind: Canary
metadata:
  name: http-check
spec:
  interval: 30
  http:
    - name: http pass response 200 status code
      url: https://httpbin.demo.aws.flanksource.com/status/200
      tlsConfig:
        ca:
          valueFrom:
            secretKeyRef:
              name: ca-cert
              key: ca.pem
```

</details>

### OAuth

<Fields rows={[
  {field: "tokenURL", description: "URL for OAuth Token", scheme: "string"},
  {field: "scope", description: "Scope for OAuth token request", scheme: "[]string"},
  {field: "params", description: "Parameters for OAuth", scheme: "map[string]string"},
]}/>

### Result Variables

Result variables can be used in `test`, `display` and `transform` [expressions](../concepts/expressions)

| Name      | Description                                                                 | Scheme              |
| --------- | --------------------------------------------------------------------------- | ------------------- |
| `code`    | HTTP response code                                                          | `int`               |
| `headers` | HTTP response headers                                                       | `map[string]string` |
| `elapsed` | HTTP Request duration                                                       | `time.Duration`     |
| `sslAge`  | Time until SSL certificate expires                                          | `time.Duration`     |
| `content` | HTTP Response body                                                          | string              |
| `json`    | If `Content-Type=application/json` response body converted into JSON object | `JSON`              |

The above canary (`http-check.yaml`) is functionally equivalent to `http-check-expr.yaml` below

```yaml title=http-check-expr.yaml
apiVersion: canaries.flanksource.com/v1
kind: Canary
metadata:
  name: http-check-expr
spec:
  interval: 30
  http:
    - name: http pass response 200 status code
      endpoint: https://httpbin.demo.aws.flanksource.com/status/200
      test:
        expr: "code in [200,201,301] and sslAge > Duration('7d')"
```

## Authentication

<details summary="Basic Authentication">

<div>
```yaml title="http_auth.yaml"   file=../../../modules/canary-checker/fixtures/minimal/http_auth.yaml
```
</div>
</details>

## Template Body Variables

| Name                          | Scheme              |
| ----------------------------- | ------------------- |
| `metadata.name`               | string              |
| `metadata.namespace` | _string_            |
| `metadata.labels`             | _map[string]string_ |
| `{fields from []env}`         | any                 |

Variables defined in `env` are available to template with the name that's configured on the spec.
Eg: In the following spec, the vars `my_secret_path` and `my_secret_var`, defined in `env`, are available during templating.

<details summary="Templating request body from env variables">

<div>
```yaml title="http_template.yaml"   file=../../../modules/canary-checker/fixtures/minimal/http_template.yaml
```
</div>
</details>

<details summary="Templating authentication from env variables">
<div>
```yaml title="http_user_pass_template.yaml"
apiVersion: canaries.flanksource.com/v1
kind: Canary
metadata:
  name: http-basic-auth-url
  namespace: canaries
spec:
  http:
    - name: test-url-via-env
      # The URL can be templated from arbritrary values using the env field and $(.) syntax
      url: $(.url)
      env:
        - name: url
          value: https://hello:world2@httpbin.demo.aws.flanksource.com/basic-auth/hello/world2
    - name: test-basic-via-env
      # the url can be constructed from multiple variables
      url: https://$(.user):$(.pass)@httpbin.demo.aws.flanksource.com/basic-auth/hello/world
      templateBody: true
      body: |
        {{. | toJSONPretty " " }}
      responseCodes: [200]
      env:
        - name: user
          value: hello
        - name: pass
          value: world
```
</div>

See <CommonLink to="gotemplate" anchor="escaping">Escaping variables</CommonLink>

## Metrics

| **HTTP Check Metrics**                                        |         |                                         |
| ------------------------------------------------------------- | ------- | --------------------------------------- |
| `canary_check_http_response_status{status, statusClass, url}` | Counter | Response code counter for each endpoint |
| `canary_check_http_ssl_expiry{url}`                           | Gauge   |                                         |

Status class is one of `1xx`, `2xx`, `3xx`, `4xx`, `5xx`

<details summary="Adding custom metrics">

<div>
```yaml title="metrics.yaml"   file=../../../modules/canary-checker/fixtures/minimal/metrics.yaml
```
</div>
</details>

<details summary="Transforming metrics into individual checks">

<div>
```yaml title="metrics.yaml"   file=../../../modules/canary-checker/fixtures/minimal/metrics-transformed.yaml
```
</div>
</details>
